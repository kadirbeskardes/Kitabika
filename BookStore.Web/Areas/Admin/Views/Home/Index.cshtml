@model BookStore.Service.DTOs.DashboardStatsDto
@{
    ViewData["Title"] = "İstatistik Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up"></i> İstatistik Dashboard</h2>
    <div class="d-flex align-items-center">
        <div class="me-3">
            <input type="date" id="startDate" class="form-control form-control-sm" />
        </div>
        <div class="me-3">
            <input type="date" id="endDate" class="form-control form-control-sm" />
        </div>
        <button class="btn btn-primary btn-sm" onclick="filterDashboard()">
            <i class="bi bi-funnel"></i> Filtrele
        </button>
    </div>
</div>

<!-- İstatistik Kartları -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Toplam Kitap
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBooks">@Model.TotalBooks</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-book fs-1 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Toplam Gelir
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalRevenue">₺@Model.TotalRevenue.ToString("N2")</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-currency-exchange fs-1 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Aylık Gelir
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="monthlyRevenue">₺@Model.MonthlyRevenue.ToString("N2")</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-calendar3 fs-1 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Bekleyen Siparişler
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingOrders">@Model.PendingOrders</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-hourglass-split fs-1 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İkinci sıra istatistikler -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Az Stokta
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="lowStockBooks">@Model.LowStockBooks</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-dark shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">
                            Aktif Ödünçler
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeLoans">@Model.ActiveLoans</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-arrow-left-right fs-1 text-dark"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-secondary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                            Ortalama Puan
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="averageRating">
                            @Model.AverageRating <small class="text-warning">★</small>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-star fs-1 text-secondary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-muted shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-muted text-uppercase mb-1">
                            Toplam Kullanıcı
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">@Model.TotalUsers</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-people fs-1 text-muted"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Grafikler ve Tablolar -->
<div class="row mb-4">
    <!-- Aylık Satış Grafiği -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Aylık Satış Trendi</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="salesChart" height="320"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Kategori Dağılımı -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Kategori Dağılımı</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İstatistik Tabloları -->
<div class="row">
    <!-- Popüler Kitaplar -->
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">En Popüler Kitaplar</h6>
                <a asp-controller="Books" asp-action="Index" class="btn btn-sm btn-primary">Tümünü Gör</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Kitap</th>
                                <th>Satış</th>
                                <th>Gelir</th>
                                <th>Puan</th>
                            </tr>
                        </thead>
                        <tbody id="popularBooksTable">
                            @foreach (var book in Model.PopularBooks.Take(5))
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="font-weight-bold">@book.Title</div>
                                                <small class="text-muted">@book.Author</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@book.SoldQuantity</td>
                                    <td>₺@book.Revenue.ToString("N2")</td>
                                    <td>
                                        <span class="text-warning">
                                            @book.AverageRating ★
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Son Aktiviteler -->
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Son Aktiviteler</h6>
            </div>
            <div class="card-body">
                <div class="max-h-300" id="recentActivities">
                    @foreach (var activity in Model.RecentActivities.Take(8))
                    {
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                @if (activity.ActivityType == "Sipariş")
                                {
                                    <div class="bg-success rounded-circle p-2">
                                        <i class="bi bi-cart text-white"></i>
                                    </div>
                                }
                                else if (activity.ActivityType == "İnceleme")
                                {
                                    <div class="bg-info rounded-circle p-2">
                                        <i class="bi bi-star text-white"></i>
                                    </div>
                                }
                            </div>
                            <div class="flex-grow-1">
                                <div class="small font-weight-bold">@activity.Description</div>
                                <div class="small text-muted">
                                    @activity.UserName • @activity.Date.ToString("dd.MM.yyyy HH:mm")
                                    @if (activity.Amount.HasValue)
                                    {
                                        <span class="text-success font-weight-bold">• ₺@activity.Amount.Value.ToString("N2")</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kategori İstatistikleri -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Kategori İstatistikleri</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="categoryStatsTable">
                        <thead>
                            <tr>
                                <th>Kategori</th>
                                <th>Kitap Sayısı</th>
                                <th>Toplam Satış</th>
                                <th>Satılan Miktar</th>
                                <th>Ortalama Fiyat</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var category in Model.CategoryStats)
                            {
                                <tr>
                                    <td class="font-weight-bold">@category.CategoryName</td>
                                    <td>@category.BookCount</td>
                                    <td class="text-success">₺@category.TotalSales.ToString("N2")</td>
                                    <td>@category.SoldQuantity</td>
                                    <td>
                                        @if (category.SoldQuantity > 0)
                                        {
                                            <span>₺@((category.TotalSales / category.SoldQuantity).ToString("N2"))</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let salesChart, categoryChart;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // Aylık Satış Grafiği
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            const salesData = @Html.Raw(Json.Serialize(Model.MonthlySales));
            
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: salesData.map(d => d.month),
                    datasets: [{
                        label: 'Gelir (₺)',
                        data: salesData.map(d => d.revenue),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Sipariş Sayısı',
                        data: salesData.map(d => d.orderCount),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Son 12 Ay Satış Performansı'
                        }
                    }
                }
            });

            // Kategori Dağılım Grafiği
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryData = @Html.Raw(Json.Serialize(Model.CategoryStats.Take(6)));
            
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(d => d.categoryName),
                    datasets: [{
                        data: categoryData.map(d => d.totalSales),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Kategorilere Göre Satış'
                        }
                    }
                }
            });
        }

        function filterDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);

            fetch(`/Admin/Home/GetDashboardData?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    updateDashboard(data);
                })
                .catch(error => {
                    console.error('Hata:', error);
                });
        }

        function updateDashboard(data) {
            // İstatistik kartlarını güncelle
            document.getElementById('totalBooks').textContent = data.totalBooks;
            document.getElementById('totalRevenue').textContent = '₺' + data.totalRevenue.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('monthlyRevenue').textContent = '₺' + data.monthlyRevenue.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('pendingOrders').textContent = data.pendingOrders;
            document.getElementById('lowStockBooks').textContent = data.lowStockBooks;
            document.getElementById('activeLoans').textContent = data.activeLoans;
            document.getElementById('averageRating').innerHTML = data.averageRating + ' <small class="text-warning">★</small>';
            document.getElementById('totalUsers').textContent = data.totalUsers;
        }
    </script>
}
